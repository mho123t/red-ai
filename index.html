<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم مطعم ريدان للمندي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (الأسلوب السابق يبقى كما هو) ... */
        
        .new-order-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- ... (بقية الهيكل يبقى كما هو) ... -->

    <!-- Notification Sound -->
    <audio id="new-order-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3"></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const ordersTableBody = document.getElementById('orders-table-body');
            const newOrderSound = document.getElementById('new-order-sound');
            
            // إحصائيات الطلبات
            let orders = [];
            let newOrdersCount = 0;
            
            // تحميل الطلبات من localStorage
            function loadOrders() {
                const savedOrders = localStorage.getItem('restaurant_orders');
                if (savedOrders) {
                    orders = JSON.parse(savedOrders);
                    updateOrdersDisplay();
                    updateStats();
                }
            }
            
            // عرض الطلبات في الجدول
            function updateOrdersDisplay(filter = 'all') {
                ordersTableBody.innerHTML = '';
                
                const filteredOrders = filter === 'all' 
                    ? orders 
                    : orders.filter(order => order.status === filter);
                
                if (filteredOrders.length === 0) {
                    ordersTableBody.innerHTML = `
                        <tr>
                            <td colspan="7">
                                <div class="no-orders">
                                    <i class="fas fa-shopping-cart"></i>
                                    <p>لا توجد طلبات</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filteredOrders.forEach(order => {
                    const row = document.createElement('tr');
                    let statusClass = '';
                    let statusText = '';
                    
                    switch(order.status) {
                        case 'pending':
                            statusClass = 'status-pending';
                            statusText = 'قيد الانتظار';
                            break;
                        case 'processing':
                            statusClass = 'status-processing';
                            statusText = 'قيد التنفيذ';
                            break;
                        case 'completed':
                            statusClass = 'status-completed';
                            statusText = 'مكتمل';
                            break;
                        case 'cancelled':
                            statusClass = 'status-cancelled';
                            statusText = 'ملغي';
                            break;
                    }
                    
                    row.innerHTML = `
                        <td>#${order.orderNumber || order.id}</td>
                        <td>${order.customerInfo?.name || order.customer || 'غير معروف'}</td>
                        <td>${order.date}</td>
                        <td>${order.method}</td>
                        <td>${order.total} درهم</td>
                        <td><span class="order-status ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn view-btn" data-id="${order.id}">
                                <i class="fas fa-eye"></i>
                                ${order.isNew ? '<span class="new-order-badge"></span>' : ''}
                            </button>
                            <button class="action-btn edit-btn" data-id="${order.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${order.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    ordersTableBody.appendChild(row);
                });
                
                // إضافة مستمعي الأحداث للأزرار
                addEventListenersToButtons();
            }
            
            // تحديث الإحصائيات
            function updateStats() {
                // ... (كود تحديث الإحصائيات السابق) ...
            }
            
            // التحقق من الطلبات الجديدة
            function checkForNewOrders() {
                const savedOrders = JSON.parse(localStorage.getItem('restaurant_orders')) || [];
                
                if (savedOrders.length > orders.length) {
                    // تحديد الطلبات الجديدة
                    const newOrders = savedOrders.slice(0, savedOrders.length - orders.length);
                    newOrdersCount += newOrders.length;
                    
                    // تحديث قائمة الطلبات
                    orders = savedOrders;
                    
                    // تشغيل الإشعار
                    showNewOrderNotification(newOrders);
                    
                    // تحديث العرض
                    updateOrdersDisplay();
                    updateStats();
                }
            }
            
            // عرض إشعار الطلب الجديد
            function showNewOrderNotification(newOrders) {
                // تشغيل الصوت
                newOrderSound.play();
                
                // عرض الإشعار المرئي
                const notification = document.querySelector('.notification');
                notification.querySelector('.notification-text').textContent = 
                    `لديك ${newOrders.length} طلب جديد!`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
                
                // تمييز الطلبات الجديدة
                newOrders.forEach(order => {
                    order.isNew = true;
                });
                
                // حفظ التغييرات
                localStorage.setItem('restaurant_orders', JSON.stringify(orders));
            }
            
            // إضافة مستمعي الأحداث للأزرار
            function addEventListenersToButtons() {
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const orderId = this.getAttribute('data-id');
                        viewOrderDetails(orderId);
                        
                        // إزالة علامة الجديد عند العرض
                        const order = orders.find(o => o.id == orderId);
                        if (order && order.isNew) {
                            order.isNew = false;
                            localStorage.setItem('restaurant_orders', JSON.stringify(orders));
                            updateOrdersDisplay();
                        }
                    });
                });
                
                // ... (بقية مستمعي الأحداث) ...
            }
            
            // بدء التحميل والمراقبة
            loadOrders();
            
            // التحقق من الطلبات الجديدة كل 3 ثوان
            setInterval(checkForNewOrders, 3000);
            
            // أيضا مراقبة تغييرات localStorage
            window.addEventListener('storage', function(event) {
                if (event.key === 'restaurant_orders') {
                    checkForNewOrders();
                }
            });
        });
    </script>
</body>
</html>